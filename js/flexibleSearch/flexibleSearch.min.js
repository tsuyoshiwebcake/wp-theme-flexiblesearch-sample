(function(a){a.fn.flexibleSearch=function(h){var s=a.extend({},a.fn.flexibleSearch.defaults,h);var r=this;if(s.searchFormCreation){var I=[];var e="";if(s.advancedFormObj!==null){if("hidden" in s.advancedFormObj){I.push(['<div class="fs-advanced-hidden" style="display:none;">',"{{#hidden}}",'<input type="hidden"','{{#id}} id="{{id}}"{{/id}}','{{#name}} name="{{name}}"{{/name}}','{{#value}} value="{{value}}"{{/value}}>',"{{/hidden}}","</div>"].join(""))}if("text" in s.advancedFormObj){I.push(['<div class="fs-advanced-text">',"{{#text}}","{{#label}}",'<label{{#id}} id="{{id}}-label"{{/id}}{{#name}} for="{{name}}"{{/name}} class="fs-text{{#name}} fs-{{name}}{{/name}}">',"{{/label}}",'<input type="text"','{{#id}} id="{{id}}"{{/id}}','{{#name}} name="{{name}}"{{/name}}','{{#value}} value="{{value}}"{{/value}}','{{#placeholder}} placeholder="{{placeholder}}"{{/placeholder}}>',"{{#label}}","{{label}}</label>","{{/label}}","{{/text}}","</div>"].join(""))}if("checkbox" in s.advancedFormObj){I.push(['<div class="fs-advanced-checkbox">',"{{#checkbox}}","{{#label}}",'<label{{#id}} id="{{id}}-label"{{/id}}{{#name}} for="{{name}}"{{/name}} class="fs-checkbox{{#name}} fs-{{name}}{{/name}}">',"{{/label}}",'<input type="checkbox"','{{#id}} id="{{id}}"{{/id}}','{{#name}} name="{{name}}"{{/name}}','{{#value}} value="{{value}}"{{/value}}','{{#checked}} checked="checked"{{/checked}}>',"{{#label}}","{{label}}</label>","{{/label}}","{{/checkbox}}","</div>"].join(""))}if("radio" in s.advancedFormObj){I.push(['<div class="fs-advanced-radio">',"{{#radio}}","{{#label}}",'<label{{#id}} id="{{id}}-label"{{/id}}{{#name}} for="{{name}}"{{/name}} class="fs-radio{{#name}} fs-{{name}}{{/name}}">',"{{/label}}",'<input type="radio"','{{#id}} id="{{id}}"{{/id}}','{{#name}} name="{{name}}"{{/name}}','{{#value}} value="{{value}}"{{/value}}','{{#checked}} checked="checked"{{/checked}}>',"{{#label}}","{{label}}</label>","{{/label}}","{{/radio}}","</div>"].join(""))}e=Mustache.render(I.join(""),s.advancedFormObj);if("select" in s.advancedFormObj){var c={selects:s.advancedFormObj.select,options:function(){var M=this.option;var N=[];for(var L=0,n=M.length;L<n;L++){var K=M[L].selected?" selected":"";N.push('<option value="'+M[L].value+'"'+K+">"+M[L].label+"</option>")}return N.join("")}};var d=['<div class="fs-advanced-select">',"{{#selects}}",'<select{{#id}} id="{{id}}"{{/id}}{{#name}} name="{{name}}"{{/name}}{{#size}} size="{{size}}"{{/size}}{{#multiple}} multiple{{/multiple}} class="fs-select{{#name}} fs-{{name}}{{/name}}">',"{{{options}}}","</select>","{{/selects}}","</div>"].join("");e+=Mustache.render(d,c)}}var g={action:s.searchFormAction,type:s.searchFormInputType,placeholder:s.searchFormInputPlaceholder,submitBtnText:s.searchFormSubmitBtnText};var b="";if(s.searchFormHTML!==null){b=s.searchFormHTML}else{var F=['<form action="{{action}}" method="GET">','<input type="hidden" name="offset" value="0">','<input type="hidden" name="limit" value="'+s.paginateCount+'">','<input type="{{type}}" name="search" placeholder="{{placeholder}}" class="fs-text fs-search">','<input type="submit" value="{{submitBtnText}}" class="fs-btn fs-submit">',e,"</form>"].join("");b=Mustache.render(F,g)}r[0].innerHTML=b}var y="";if(s.loadingImgHTML!==null){y=s.loadingImgHTML}else{if(s.loadingImgPath){y='<span class="fs-loading"><img src="'+s.loadingImgPath+'" alt=""></span>'}}var j="";if(s.resultMsgTmpl!==null){j=s.resultMsgTmpl}else{j=['<div id="'+s.resultBlockId+'-msg">',"<p>","{{#keywords}}「{{keywords}}」が {{/keywords}}","{{#count}}{{count}} 件見つかりました。{{/count}}","{{^count}}見つかりませんでした。{{/count}}","{{#count}}（{{lastPage}} ページ中 {{currentPage}} ページ目を表示）{{/count}}","</p>","</div>"].join("")}var G="";if(s.resultItemTmpl!==null){G=s.resultItemTmpl}else{G=['<div id="'+s.resultBlockId+'-items">',"<ul>","{{#items}}","<li>{{&title}}</li>","{{/items}}","</ul>","</div>"].join("")}var u="";if(s.paginateTmpl!==null){u=s.paginateTmpl}else{u=['<div id="{{id}}">',"<ul>","{{#page}}",'<li{{&current}}><span><a href="#" title="{{.}}">{{.}}</a></span></li>',"{{/page}}","</ul>","</div>"].join("")}r.find("form").on("submit",function(N){N.preventDefault();var K=a(this).attr("action")||location.href.replace(/\?.*/,"");var O=a(this).serializeArray();for(var L=-1,P=O.length;++L<P;){if(O[L].name==="search"){O[L].value=a.trim(O[L].value.replace("　"," "))}}O=s.submitAction(O);var M=a.param(O);if(M){K=K+"?"+M}location.href=K;return false});var k=decodeURIComponent(location.search.replace(/^\?/,""));if(k===""){switch(typeof s.searchDataPathPreload){case"string":a.ajax({type:"GET",cache:true,dataType:"json",url:s.searchDataPathPreload});break;case"object":if(s.searchDataPathPreload.length){for(var B=-1,w=s.searchDataPathPreload.length;++B<w;){a.ajax({type:"GET",cache:true,dataType:"json",url:s.searchDataPathPreload[B]})}}else{for(var J in s.searchDataPathPreload){a.ajax({type:"GET",cache:true,dataType:"json",url:s.searchDataPathPreload[J]})}}break}return false}if(y){document.getElementById(s.resultBlockId).innerHTML=y}var f=[];var t=k.split(/&|%26/);var p=[];var m={};var o=0;var D=10;var C="";var z="";var v=false;var l=["search","dataId","offset","limit"];if(s.excludeParams!==null){a.merge(l,s.excludeParams.toLowerCase().split(","))}for(var B=-1,w=t.length;++B<w;){var q=t[B].split("=");var J=q[0];var x=q[1]||"";switch(J){case"search":x=(x==="+")?"":x;f=x.split(/\+| |%20/);break;case"offset":o=x;break;case"limit":D=x;break;case"dataId":z=x;break}if(J==="offset"||J==="limit"){continue}r.find("[name='"+J+"']").each(function(){var n=this.tagName.toLowerCase();switch(n){case"input":var i=a(this).attr("type");if(i==="checkbox"&&a(this).val()===x){a(this).prop("checked",true)}else{if(i==="radio"&&a(this).val()===x){a(this).prop("checked",true)}else{if(i==="text"||i==="search"||i==="hidden"){if(J==="search"){a(this).val(x.replace("+"," "))}else{a(this).val(x)}}}}break;case"select":a(this).find("option").each(function(){if(a(this).val()===x){a(this).prop("selected",true)}else{if(x===""&&a(this).val()===" "){a(this).prop("selected",true)}}});break}});if(x!==""){if(a.inArray(J,l)!==-1){continue}if(a.inArray(J,p)!==-1){m[J]+=","+x}else{m[J]=x}}p.push(J)}var H=0;for(var J in m){H++}switch(typeof s.searchDataPath){case"string":C=s.searchDataPath;break;case"object":if(z===""){window.alert("dataId is required.");return}else{if(s.dataApiDataIds!==null&&a.inArray(z,s.dataApiDataIds.split(","))!==-1){v=true;if(s.dataApiParams!==null){k+=(k!=="")?"&"+a.param(s.dataApiParams):a.param(s.dataApiParams)}}C=s.searchDataPath[z]}break}if(v){C+="?"+k}a.ajax({type:"GET",cache:s.cache,dataType:"json",url:C,error:function(i,K,n){s.ajaxError(i,K,n)},success:function(P){var M={};if(v){M=P}else{var R=a.grep(P.items,function(){return true});R=a.grep(R,function(X,n){return E(X,m,H,"like")});R=a.grep(R,function(X,n){return A(X,f)});var T=Number(D)+Number(o);M.totalResults=R.length;M.items=a.grep(R,function(X,n){if(n<o){return false}else{if(n>=T){return false}else{return true}}})}var V=Math.ceil(o/D)+1;var O=[];for(var S=0,L=Math.ceil(M.totalResults/D);++S<=L;){O.push(S)}var W={id:s.paginateId,page:O,current:function(){if(this===V){return' class="fs-current"'}else{return""}}};var U=Mustache.render(u,W);var K={keywords:f.join(", "),count:M.totalResults,firstPage:function(){return W.page[0]},lastPage:function(){return W.page[W.page.length-1]},currentPage:V};var N=Mustache.render(j,K);var Q=Mustache.render(G,M);document.getElementById(s.resultBlockId).innerHTML=N+Q+U;a("#"+s.paginateId).on("click","a",function(Y){Y.preventDefault();var X=a(this).attr("title");var Z=(Number(X)-1)*Number(D);Z="offset="+Z;var i=location.href.split("?");var n=i[1].replace(/offset=[0-9]+/,Z);location.href=i[0]+"?"+n})}});function E(P,S,O,K){var L=0;if(K==="like"){for(var T in S){var R=S[T].split(",");for(var Q=-1,N=R.length;++Q<N;){var M=new RegExp(R[Q],"i");if(typeof P[T]==="undefined"||typeof P[T]==="string"&&M.test(P[T])){L++;break}}}return L===O}else{for(var T in S){if(P[T]&&typeof P[T]==="string"&&P[T]!==S[T]){return false}}}return L}function A(O,P){var N=P.length;var n=0;for(var L=-1;++L<N;){var M=new RegExp(P[L],"i");for(var K in O){if(M.test(O[K])){n++;break}}}return(N===n)}};a.fn.flexibleSearch.defaults={searchDataPath:"/flexibleSearch/search.json",searchDataPathPreload:"/flexibleSearch/search.json",dataApiDataIds:null,dataApiParams:null,cache:true,searchFormCreation:true,searchFormHTML:null,searchFormAction:"",searchFormInputType:"search",searchFormInputPlaceholder:"Search words",searchFormSubmitBtnText:"Search",advancedFormObj:null,loadingImgPath:"/flexibleSearch/loading.gif",loadingImgHTML:null,resultBlockId:"fs-result",resultMsgTmpl:null,resultItemTmpl:null,paginateId:"fs-paginate",paginateTmpl:null,paginateCount:10,submitAction:function(b){return b},ajaxError:function(b,d,c){window.alert(d)},excludeParams:null,dummy:false}})(jQuery);